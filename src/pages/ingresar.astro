---
import Layout from "@/layouts/BaseLayout.astro";
import { createClient } from "@/lib/supabase";

const { cookies, redirect } = Astro;

const supabase = createClient({
  request: Astro.request,
  cookies: Astro.cookies,
});

const { data } = await supabase.auth.getUser();

if (data.user) {
  return Astro.redirect("/admin");
}
---

<Layout title="Iniciar Sesión">
  <div class="signin-container">
    <div class="signin-card">
      <div class="signin-header">
        <h1 class="signin-title">Bienvenido de nuevo</h1>
        <p class="signin-subtitle">Ingresa tus credenciales para continuar</p>
      </div>

      <form id="signinForm" class="signin-form">
        <div class="form-group">
          <label for="email" class="form-label"
            >Dirección de correo electrónico</label
          >
          <input
            type="email"
            name="email"
            id="email"
            class="form-input"
            placeholder="Dirección de correo electrónico"
            autocomplete="email"
            required
          />
          <span class="form-error" id="emailError"></span>
        </div>

        <div class="form-group">
          <label for="password" class="form-label">Contraseña</label>
          <div class="password-input-wrapper">
            <input
              type="password"
              name="password"
              id="password"
              class="form-input"
              placeholder="Contraseña"
              autocomplete="current-password"
              required
              minlength="6"
            />
            <button
              type="button"
              class="password-toggle"
              id="togglePassword"
              aria-label="Mostrar contraseña"
            >
              <svg
                class="eye-icon"
                id="eyeIcon"
                width="24"
                height="24"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                <circle cx="12" cy="12" r="3"></circle>
              </svg>
              <svg
                class="eye-off-icon hidden"
                id="eyeOffIcon"
                width="24"
                height="24"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <path
                  d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"
                ></path>
                <line x1="1" y1="1" x2="23" y2="23"></line>
              </svg>
            </button>
          </div>
          <span class="form-error" id="passwordError"></span>
        </div>

        <div class="form-error-message" id="formErrorMessage"></div>

        <button type="submit" class="submit-button" id="submitButton">
          <span class="button-text">INICIAR SESIÓN</span>
          <span class="button-loader hidden" id="buttonLoader">
            <svg
              class="spinner"
              width="20"
              height="20"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
            >
              <circle cx="12" cy="12" r="10" opacity="0.25"></circle>
              <path d="M12 2a10 10 0 0 1 10 10" opacity="0.75"></path>
            </svg>
          </span>
        </button>
      </form>
    </div>
  </div>

  <style>
    .signin-container {
      min-height: calc(100vh - 120px);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 2rem 1rem;
      background: linear-gradient(135deg, #f5f7fa 0%, #e8ecf1 100%);
    }

    .signin-card {
      background: white;
      border-radius: 16px;
      box-shadow:
        0 4px 6px rgba(0, 0, 0, 0.02),
        0 12px 24px rgba(0, 0, 0, 0.06);
      padding: 3rem 2rem;
      width: 100%;
      max-width: 480px;
      animation: slideUp 0.4s ease-out;
    }

    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .signin-header {
      text-align: center;
      margin-bottom: 2.5rem;
    }

    .signin-title {
      font-size: 1.875rem;
      font-weight: 700;
      color: #1a1a1a;
      margin: 0 0 0.5rem 0;
      letter-spacing: -0.02em;
    }

    .signin-subtitle {
      font-size: 1rem;
      color: #6b7280;
      margin: 0;
    }

    .signin-form {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .form-group {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .form-label {
      font-size: 0.875rem;
      font-weight: 500;
      color: #374151;
      margin-bottom: 0.25rem;
    }

    .form-input {
      width: 100%;
      padding: 0.875rem 1rem;
      font-size: 1rem;
      color: #1a1a1a;
      background: #f9fafb;
      border: 2px solid #e5e7eb;
      border-radius: 10px;
      outline: none;
      transition: all 0.2s ease;
      font-family: inherit;
    }

    .form-input::placeholder {
      color: #9ca3af;
    }

    .form-input:hover {
      border-color: #d1d5db;
      background: #ffffff;
    }

    .form-input:focus {
      border-color: #1a1a1a;
      background: #ffffff;
      box-shadow: 0 0 0 3px rgba(0, 0, 0, 0.05);
    }

    .form-input.error {
      border-color: #ef4444;
      background: #fef2f2;
    }

    .form-input.error:focus {
      box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.1);
    }

    .password-input-wrapper {
      position: relative;
      display: flex;
      align-items: center;
    }

    .password-input-wrapper .form-input {
      padding-right: 3rem;
    }

    .password-toggle {
      position: absolute;
      right: 0.75rem;
      background: none;
      border: none;
      color: #6b7280;
      cursor: pointer;
      padding: 0.5rem;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: color 0.2s ease;
      border-radius: 6px;
    }

    .password-toggle:hover {
      color: #1a1a1a;
      background: #f3f4f6;
    }

    .password-toggle:focus {
      outline: 2px solid #1a1a1a;
      outline-offset: 2px;
    }

    .eye-icon,
    .eye-off-icon {
      width: 20px;
      height: 20px;
    }

    .hidden {
      display: none !important;
    }

    .form-error {
      font-size: 0.875rem;
      color: #ef4444;
      min-height: 1.25rem;
      display: block;
      margin-top: 0.25rem;
      transition: opacity 0.2s ease;
    }

    .form-error:empty {
      opacity: 0;
    }

    .form-error-message {
      padding: 1rem;
      background: #fef2f2;
      border: 1px solid #fecaca;
      border-radius: 10px;
      color: #dc2626;
      font-size: 0.875rem;
      text-align: center;
      display: none;
      animation: shake 0.4s ease;
    }

    .form-error-message.visible {
      display: block;
    }

    @keyframes shake {
      0%,
      100% {
        transform: translateX(0);
      }
      25% {
        transform: translateX(-10px);
      }
      75% {
        transform: translateX(10px);
      }
    }

    .submit-button {
      width: 100%;
      padding: 1rem;
      font-size: 0.875rem;
      font-weight: 700;
      letter-spacing: 0.05em;
      color: white;
      background: #1a1a1a;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
    }

    .submit-button:hover:not(:disabled) {
      background: #000000;
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    .submit-button:active:not(:disabled) {
      transform: translateY(0);
    }

    .submit-button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .spinner {
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      from {
        transform: rotate(0deg);
      }
      to {
        transform: rotate(360deg);
      }
    }

    @media (max-width: 640px) {
      .signin-card {
        padding: 2rem 1.5rem;
      }

      .signin-title {
        font-size: 1.5rem;
      }

      .signin-subtitle {
        font-size: 0.875rem;
      }
    }
  </style>

  <script>
    // Elementos del DOM
    const form = document.getElementById("signinForm") as HTMLFormElement;
    const emailInput = document.getElementById("email") as HTMLInputElement;
    const passwordInput = document.getElementById(
      "password"
    ) as HTMLInputElement;
    const emailError = document.getElementById("emailError") as HTMLSpanElement;
    const passwordError = document.getElementById(
      "passwordError"
    ) as HTMLSpanElement;
    const formErrorMessage = document.getElementById(
      "formErrorMessage"
    ) as HTMLDivElement;
    const submitButton = document.getElementById(
      "submitButton"
    ) as HTMLButtonElement;
    const buttonText = submitButton.querySelector(
      ".button-text"
    ) as HTMLSpanElement;
    const buttonLoader = document.getElementById(
      "buttonLoader"
    ) as HTMLSpanElement;
    const togglePassword = document.getElementById(
      "togglePassword"
    ) as HTMLButtonElement;
    const eyeIcon = document.getElementById("eyeIcon") as SVGElement;
    const eyeOffIcon = document.getElementById("eyeOffIcon") as SVGElement;

    // Toggle mostrar/ocultar contraseña
    togglePassword.addEventListener("click", () => {
      const isPassword = passwordInput.type === "password";
      passwordInput.type = isPassword ? "text" : "password";
      eyeIcon.classList.toggle("hidden");
      eyeOffIcon.classList.toggle("hidden");
      togglePassword.setAttribute(
        "aria-label",
        isPassword ? "Ocultar contraseña" : "Mostrar contraseña"
      );
    });

    // Validación de email
    function validateEmail(email: string): boolean {
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      return emailRegex.test(email);
    }

    // Limpiar error al escribir
    emailInput.addEventListener("input", () => {
      emailError.textContent = "";
      emailInput.classList.remove("error");
      formErrorMessage.classList.remove("visible");
    });

    passwordInput.addEventListener("input", () => {
      passwordError.textContent = "";
      passwordInput.classList.remove("error");
      formErrorMessage.classList.remove("visible");
    });

    // Validación en blur
    emailInput.addEventListener("blur", () => {
      const email = emailInput.value.trim();
      if (email && !validateEmail(email)) {
        emailError.textContent =
          "Por favor, ingresa un correo electrónico válido";
        emailInput.classList.add("error");
      }
    });

    passwordInput.addEventListener("blur", () => {
      const password = passwordInput.value;
      if (password && password.length < 6) {
        passwordError.textContent =
          "La contraseña debe tener al menos 6 caracteres";
        passwordInput.classList.add("error");
      }
    });

    // Manejo del submit
    form.addEventListener("submit", async (e) => {
      e.preventDefault();

      // Limpiar errores previos
      emailError.textContent = "";
      passwordError.textContent = "";
      formErrorMessage.classList.remove("visible");
      emailInput.classList.remove("error");
      passwordInput.classList.remove("error");

      // Obtener valores
      const email = emailInput.value.trim();
      const password = passwordInput.value;

      // Validación
      let hasError = false;

      if (!email) {
        emailError.textContent = "El correo electrónico es requerido";
        emailInput.classList.add("error");
        hasError = true;
      } else if (!validateEmail(email)) {
        emailError.textContent =
          "Por favor, ingresa un correo electrónico válido";
        emailInput.classList.add("error");
        hasError = true;
      }

      if (!password) {
        passwordError.textContent = "La contraseña es requerida";
        passwordInput.classList.add("error");
        hasError = true;
      } else if (password.length < 6) {
        passwordError.textContent =
          "La contraseña debe tener al menos 6 caracteres";
        passwordInput.classList.add("error");
        hasError = true;
      }

      if (hasError) {
        // Focus en el primer campo con error
        if (emailInput.classList.contains("error")) {
          emailInput.focus();
        } else if (passwordInput.classList.contains("error")) {
          passwordInput.focus();
        }
        return;
      }

      // Deshabilitar botón y mostrar loader
      submitButton.disabled = true;
      buttonText.classList.add("hidden");
      buttonLoader.classList.remove("hidden");

      try {
        const formData = new FormData();
        formData.append("email", email);
        formData.append("password", password);

        const response = await fetch("/api/auth/signin", {
          method: "POST",
          body: formData,
        });

        if (response.ok) {
          // Redirección exitosa
          window.location.href = "/admin";
        } else {
          // Error de autenticación
          const errorText = await response.text();
          let errorMessage =
            "Credenciales incorrectas. Por favor, verifica tu correo y contraseña.";

          // Personalizar mensajes de error
          if (errorText.toLowerCase().includes("invalid")) {
            errorMessage =
              "Correo o contraseña incorrectos. Por favor, inténtalo de nuevo.";
          } else if (errorText.toLowerCase().includes("not found")) {
            errorMessage = "No existe una cuenta con este correo electrónico.";
          } else if (errorText.toLowerCase().includes("rate limit")) {
            errorMessage =
              "Demasiados intentos. Por favor, espera un momento antes de intentar de nuevo.";
          }

          formErrorMessage.textContent = errorMessage;
          formErrorMessage.classList.add("visible");

          // Añadir efecto de error a los inputs
          emailInput.classList.add("error");
          passwordInput.classList.add("error");
          passwordInput.select();
        }
      } catch (error) {
        console.error("Error al iniciar sesión:", error);
        formErrorMessage.textContent =
          "Error de conexión. Por favor, verifica tu conexión a internet e inténtalo de nuevo.";
        formErrorMessage.classList.add("visible");
      } finally {
        // Restaurar botón
        submitButton.disabled = false;
        buttonText.classList.remove("hidden");
        buttonLoader.classList.add("hidden");
      }
    });
  </script>
</Layout>
