---
import CMSLayout from "@/layouts/CMSLayout.astro";
import { getAllCategoriesWithSubcategories } from "@/lib/data/admin";
import { createClient } from "@/lib/supabase";
import ProductForm from "@/components/admin/ProductForm";

const supabase = createClient({
  request: Astro.request,
  cookies: Astro.cookies,
});

const { productSlug } = Astro.params;

if (!productSlug) {
  return Astro.redirect("/admin/productos");
}

const { data: product, error } = await supabase
  .from("products")
  .select(
    `
    *,
    categories(id, name),
    subcategories(id, name),
    product_assets(*)
  `
  )
  .eq("slug", productSlug)
  .single();

if (error || !product) {
  return Astro.redirect("/admin/productos");
}

const processedAssets = (product.product_assets || [])
  .map((asset: any) => {
    const { data } = supabase.storage
      .from(asset.storage_bucket)
      .getPublicUrl(asset.storage_path);
    return {
      id: asset.id,
      public_url: data?.publicUrl || null,
      alt: asset.alt,
      title: asset.title,
      is_primary: asset.is_primary,
      is_secondary: asset.is_secondary || false,
      section: asset.section || "gallery",
      kind: asset.kind || "image",
      filename: asset.filename,
      file_size_bytes: asset.file_size_bytes,
      mime_type: asset.mime_type,
      sort_order: asset.sort_order,
    };
  })
  .sort((a: any, b: any) => a.sort_order - b.sort_order);

const assetsGrouped = {
  gallery: processedAssets.filter((a: any) => a.section === "gallery"),
  additional: processedAssets.filter((a: any) => a.section === "additional"),
  download: processedAssets.filter((a: any) => a.section === "download"),
};

const categories = await getAllCategoriesWithSubcategories(supabase);

const isNew = Astro.url.searchParams.get("created") === "true";

const productData = {
  id: product.id,
  name: product.name,
  slug: product.slug,
  description: product.description,
  brand: product.brand,
  price: product.price,
  stock: product.stock,
  category_id: product.category_id,
  subcategory_id: product.subcategory_id,
  attributes: product.attributes || {},
  created_at: product.created_at,
};
---

<CMSLayout title={`${product.name} - ARM Admin`} description="Editar producto">
  <ProductForm
    client:load
    product={productData}
    assets={assetsGrouped}
    categories={categories}
    isNew={isNew}
  />
</CMSLayout>
