---
import Layout from "@/layouts/BaseLayout.astro";
import { createClient } from "@/lib/supabase";

const supabase = createClient({
  request: Astro.request,
  cookies: Astro.cookies,
});

// Obtener datos del usuario autenticado
const { data: userData } = await supabase.auth.getUser();
const user = userData.user;

// Obtener sesi√≥n actual
const { data: sessionData } = await supabase.auth.getSession();
const session = sessionData.session;

// Calcular tiempo de sesi√≥n
const sessionCreatedAt = session?.created_at 
  ? new Date(session.created_at * 1000) 
  : null;
const sessionExpiresAt = session?.expires_at 
  ? new Date(session.expires_at * 1000) 
  : null;

// Formatear fechas
const formatDate = (date: Date | null) => {
  if (!date) return "N/A";
  return date.toLocaleString("es-ES", {
    year: "numeric",
    month: "long",
    day: "numeric",
    hour: "2-digit",
    minute: "2-digit",
  });
};

const formatRelativeTime = (date: Date | null) => {
  if (!date) return "N/A";
  const now = new Date();
  const diff = date.getTime() - now.getTime();
  const minutes = Math.floor(diff / 60000);
  const hours = Math.floor(minutes / 60);
  const days = Math.floor(hours / 24);
  
  if (days > 0) return `${days} d√≠a${days > 1 ? 's' : ''}`;
  if (hours > 0) return `${hours} hora${hours > 1 ? 's' : ''}`;
  if (minutes > 0) return `${minutes} minuto${minutes > 1 ? 's' : ''}`;
  return "Menos de 1 minuto";
};
---

<Layout title="Dashboard">
  <div class="dashboard-container">
    <div class="dashboard-content">
      
      <!-- Header -->
      <div class="card header-card">
        <div class="header-content">
          <div class="header-text">
            <h1 class="title">¬°Bienvenido de vuelta! üëã</h1>
            <p class="subtitle">
              Nos alegra verte por aqu√≠, <span class="highlight">{user?.email}</span>
            </p>
          </div>
          <button id="logout-btn" class="btn btn-logout">
            Cerrar Sesi√≥n
          </button>
        </div>
      </div>

      <!-- Grid de Estad√≠sticas -->
      <div class="stats-grid">
        
        <!-- User ID -->
        <div class="card stat-card">
          <div class="stat-content">
            <div class="stat-text">
              <p class="stat-label">ID de Usuario</p>
              <p class="stat-value" title={user?.id}>
                {user?.id?.substring(0, 8)}...
              </p>
            </div>
            <div class="stat-icon icon-blue">
              <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
              </svg>
            </div>
          </div>
        </div>

        <!-- Email Verificado -->
        <div class="card stat-card">
          <div class="stat-content">
            <div class="stat-text">
              <p class="stat-label">Email Verificado</p>
              <p class="stat-value">
                {user?.email_confirmed_at ? (
                  <span class="verified">‚úì Verificado</span>
                ) : (
                  <span class="pending">‚ö† Pendiente</span>
                )}
              </p>
            </div>
            <div class={`stat-icon ${user?.email_confirmed_at ? 'icon-green' : 'icon-yellow'}`}>
              <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
              </svg>
            </div>
          </div>
        </div>

        <!-- Proveedor de Auth -->
        <div class="card stat-card">
          <div class="stat-content">
            <div class="stat-text">
              <p class="stat-label">M√©todo de Acceso</p>
              <p class="stat-value capitalize">
                {user?.app_metadata?.provider || "Email"}
              </p>
            </div>
            <div class="stat-icon icon-purple">
              <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z" />
              </svg>
            </div>
          </div>
        </div>

        <!-- Rol del Usuario -->
        <div class="card stat-card">
          <div class="stat-content">
            <div class="stat-text">
              <p class="stat-label">Rol</p>
              <p class="stat-value capitalize">
                {user?.role || "authenticated"}
              </p>
            </div>
            <div class="stat-icon icon-indigo">
              <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" />
              </svg>
            </div>
          </div>
        </div>
      </div>

      <!-- Grid de Informaci√≥n Detallada -->
      <div class="info-grid">
        
        <!-- Informaci√≥n del Usuario -->
        <div class="card info-card">
          <h2 class="info-title">
            <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            Informaci√≥n Personal
          </h2>
          <div class="info-list">
            <div class="info-item">
              <p class="info-label">Correo Electr√≥nico</p>
              <p class="info-value">{user?.email}</p>
            </div>
            <div class="info-item">
              <p class="info-label">Tel√©fono</p>
              <p class="info-value">{user?.phone || "No proporcionado"}</p>
            </div>
            <div class="info-item">
              <p class="info-label">Cuenta Creada</p>
              <p class="info-value">
                {formatDate(user?.created_at ? new Date(user.created_at) : null)}
              </p>
            </div>
            <div class="info-item">
              <p class="info-label">√öltima Actualizaci√≥n</p>
              <p class="info-value">
                {formatDate(user?.updated_at ? new Date(user.updated_at) : null)}
              </p>
            </div>
          </div>
        </div>

        <!-- Informaci√≥n de la Sesi√≥n -->
        <div class="card info-card">
          <h2 class="info-title">
            <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
            </svg>
            Informaci√≥n de Sesi√≥n
          </h2>
          <div class="info-list">
            <div class="info-item">
              <p class="info-label">Estado de Sesi√≥n</p>
              <p class="info-value">
                <span class="session-active">
                  <span class="pulse-dot"></span>
                  Activa
                </span>
              </p>
            </div>
            <div class="info-item">
              <p class="info-label">Sesi√≥n Iniciada</p>
              <p class="info-value">{formatDate(sessionCreatedAt)}</p>
            </div>
            <div class="info-item">
              <p class="info-label">Expira En</p>
              <p class="info-value">{formatRelativeTime(sessionExpiresAt)}</p>
            </div>
            <div class="info-item">
              <p class="info-label">Tipo de Token</p>
              <p class="info-value capitalize">{session?.token_type || "Bearer"}</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Metadata Adicional -->
      {user?.user_metadata && Object.keys(user.user_metadata).length > 0 && (
        <div class="card metadata-card">
          <h2 class="info-title">
            <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4" />
            </svg>
            Metadata del Usuario
          </h2>
          <div class="metadata-content">
            <pre class="metadata-json">{JSON.stringify(user.user_metadata, null, 2)}</pre>
          </div>
        </div>
      )}

      <!-- App Metadata -->
      {user?.app_metadata && Object.keys(user.app_metadata).length > 0 && (
        <div class="card metadata-card">
          <h2 class="info-title">
            <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4" />
            </svg>
            Metadata de Aplicaci√≥n
          </h2>
          <div class="metadata-content">
            <pre class="metadata-json">{JSON.stringify(user.app_metadata, null, 2)}</pre>
          </div>
        </div>
      )}
    </div>
  </div>
</Layout>

<style>
  * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
  }

  .dashboard-container {
    min-height: 100vh;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    padding: 2rem 1rem;
  }

  .dashboard-content {
    max-width: 1200px;
    margin: 0 auto;
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
  }

  .card {
    background: white;
    border-radius: 12px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    padding: 1.5rem;
    transition: transform 0.2s, box-shadow 0.2s;
  }

  .card:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 12px rgba(0, 0, 0, 0.15);
  }

  /* Header Card */
  .header-card {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
  }

  .header-content {
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 1rem;
  }

  .header-text {
    flex: 1;
    min-width: 250px;
  }

  .title {
    font-size: 2rem;
    font-weight: bold;
    margin-bottom: 0.5rem;
  }

  .subtitle {
    font-size: 1.1rem;
    opacity: 0.9;
  }

  .highlight {
    font-weight: 600;
    text-decoration: underline;
  }

  /* Button */
  .btn {
    padding: 0.75rem 1.5rem;
    border: none;
    border-radius: 8px;
    font-size: 1rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s;
  }

  .btn-logout {
    background: #ef4444;
    color: white;
  }

  .btn-logout:hover {
    background: #dc2626;
    transform: scale(1.05);
  }

  .btn-logout:disabled {
    background: #9ca3af;
    cursor: not-allowed;
    transform: none;
  }

  /* Stats Grid */
  .stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 1.5rem;
  }

  .stat-card {
    background: white;
  }

  .stat-content {
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .stat-text {
    flex: 1;
  }

  .stat-label {
    color: #6b7280;
    font-size: 0.875rem;
    font-weight: 500;
    margin-bottom: 0.5rem;
  }

  .stat-value {
    color: #1f2937;
    font-size: 1.25rem;
    font-weight: bold;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .stat-icon {
    padding: 0.75rem;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .icon-blue {
    background: #dbeafe;
    color: #2563eb;
  }

  .icon-green {
    background: #dcfce7;
    color: #16a34a;
  }

  .icon-yellow {
    background: #fef3c7;
    color: #ca8a04;
  }

  .icon-purple {
    background: #f3e8ff;
    color: #9333ea;
  }

  .icon-indigo {
    background: #e0e7ff;
    color: #4f46e5;
  }

  .verified {
    color: #16a34a;
  }

  .pending {
    color: #ca8a04;
  }

  .capitalize {
    text-transform: capitalize;
  }

  /* Info Grid */
  .info-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 1.5rem;
  }

  .info-card {
    background: white;
  }

  .info-title {
    font-size: 1.5rem;
    font-weight: bold;
    color: #1f2937;
    margin-bottom: 1.5rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .info-title svg {
    color: #667eea;
  }

  .info-list {
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }

  .info-item {
    padding-bottom: 1rem;
    border-bottom: 1px solid #e5e7eb;
  }

  .info-item:last-child {
    border-bottom: none;
    padding-bottom: 0;
  }

  .info-label {
    color: #6b7280;
    font-size: 0.875rem;
    font-weight: 500;
    margin-bottom: 0.25rem;
  }

  .info-value {
    color: #1f2937;
    font-weight: 600;
  }

  .session-active {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
  }

  .pulse-dot {
    width: 8px;
    height: 8px;
    background: #16a34a;
    border-radius: 50%;
    animation: pulse 2s infinite;
  }

  @keyframes pulse {
    0%, 100% {
      opacity: 1;
    }
    50% {
      opacity: 0.5;
    }
  }

  /* Metadata Cards */
  .metadata-card {
    background: white;
  }

  .metadata-content {
    background: #f9fafb;
    border-radius: 8px;
    padding: 1rem;
    overflow-x: auto;
  }

  .metadata-json {
    color: #1f2937;
    font-family: 'Courier New', monospace;
    font-size: 0.875rem;
    line-height: 1.5;
    white-space: pre-wrap;
    word-wrap: break-word;
  }

  /* Responsive */
  @media (max-width: 768px) {
    .dashboard-container {
      padding: 1rem 0.5rem;
    }

    .title {
      font-size: 1.5rem;
    }

    .subtitle {
      font-size: 0.95rem;
    }

    .header-content {
      flex-direction: column;
      align-items: stretch;
    }

    .btn-logout {
      width: 100%;
    }

    .stats-grid {
      grid-template-columns: 1fr;
    }

    .info-grid {
      grid-template-columns: 1fr;
    }
  }
</style>

<script>
  const logoutBtn = document.getElementById("logout-btn") as HTMLButtonElement;

  logoutBtn?.addEventListener("click", async () => {
    logoutBtn.disabled = true;
    logoutBtn.textContent = "Cerrando sesi√≥n...";

    try {
      const response = await fetch("/api/auth/signout", {
        method: "POST",
      });

      const result = await response.json();

      if (!result.success) {
        alert(result.message || "Error al cerrar sesi√≥n");
        logoutBtn.disabled = false;
        logoutBtn.textContent = "Cerrar Sesi√≥n";
        return;
      }

      window.location.href = "/ingresar";
    } catch (error) {
      console.error(error);
      alert("Error inesperado al cerrar sesi√≥n");
      logoutBtn.disabled = false;
      logoutBtn.textContent = "Cerrar Sesi√≥n";
    }
  });
</script>